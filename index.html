<!DOCTYPE html>
<html>
<head>
    <title>W2UI Demo: layout/4</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://rawgit.com/vitmalina/w2ui/master/dist/w2ui.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://rawgit.com/vitmalina/w2ui/master/dist/w2ui.min.css" />
	<script src="https://d3js.org/d3.v6.min.js"></script>
	<script type='text/javascript' > 
		var objs;
		var data;
    var objectsByDots;

    var convexHull;

    var shadeObjectRegion;

    function compareLocation(loc1, loc2) {
        return String(loc1.x) == String(loc2.x) && String(loc1.y) == String(loc2.y)
    }

    function getFragmentName(x, y, index) {
      return "(" + x + ", " + y + ")-" + index
    }

    // require('requirejs')
    // var convexHull = require('monotone-convex-hull-2d')
	</script>
  <script src="bundle.js"></script>
  <script src="./js/map.js"></script>
</head>
<body>

<div id="layout" style="position: absolute; width: 100%; top: 0px; bottom: 0px;"></div>

<style>
.w2ui-sidebar[name=navigation] .w2ui-node-handle > div{
    width: 11px;
    height: 11px;
    border-radius: 10px;
    margin-left: 15px;
    margin-top: 7px;
    display: inline-block;
    background-color: #e1e1e1;
    border: 1px solid transparent
}
.w2ui-sidebar[name=navigation] .w2ui-sidebar-body .w2ui-node .w2ui-node-handle > div:hover {
    border: 1px solid #55ca2e
}
.w2ui-sidebar[name=navigation] .w2ui-sidebar-body .w2ui-node .w2ui-node-handle > div.toggle {
    background-color: #55ca2e;
    border: 1px solid #55ca2e
}
</style>
<div style="clear: both"/>



<script type="text/javascript">
  $(function () {
    $().w2form({
      name: 'visualizations',
      fields: [
        { field: 'lines', type: 'checkbox',
            html: {
                label: 'Lines'
            }
        },
        { field: 'shade', type: 'checkbox',
            html: {
                label: 'Shade'
            },
            onChange() {
              shadeObjectRegion(state.selectedObject)
            }
        },
      ]
    })

    console.log()

    w2ui['visualizations'].on('*', function (event) {
        //console.log(event)
        if(event.type == 'change') {
          var form = w2ui['visualizations'].fields.find(f => f.field == event.target)
          form.onChange()
        }
        // let edata = $.extend({}, event)
        // if (edata.originalEvent) edata.originalEvent = {'...':'...'}
        // if (edata.error) edata.error = {'...':'...'}
        // if (edata.errors) edata.errors = {'...':'...'}
        // if (edata.xhr) edata.xhr = {'...':'...'}
        // $('#preview').html(`Event: ${event.type}<pre style="font-size: 12px; line-height: 1.4">${JSON.stringify(edata, null, 2)}</pre>`);
        // console.log('Event: '+ event.type, 'Target: '+ event.target, event);
    });

    var pstyle = 'border: 1px solid #efefef; padding: 5px;';
    $('#layout').w2layout({
        name: 'layout',
        panels: [
            { type: 'top', style: pstyle, content: 'top', resizable: true },
            { type: 'left', size: 300, style: pstyle, content: 'left', resizable: true },
            { type: 'main', style: pstyle, html: `<div id='map'></div>`, resizable: true },
			      { type: 'right', content: 'right', resizable: true,
              tabs: [
                { id: 'infoTab', text: 'Info',
                  onClick() {
                    if (state != null && state.selectedObject != null) {
                      var object = state.selectedObject
                      w2ui['layout'].html('right', `This is <b>${object._name}</b>. It is a <b>${object._type}</b>. It has <b>${object.location.length}</b> fragments.`)
                    }
                  }       
                },
                { id: 'propertiesTab', text: 'Properties',
                  onClick() {
                    if (state != null && state.selectedObject != null) {
                      w2ui['layout'].html('right',
                        w2ui['visualizations'])  
                    }
                  }
                }
              ],
              loadObject() {
                this.tabs.click(this.tabs.active)
              }
            }
            //https://stackoverflow.com/questions/16510991/how-can-i-make-a-layout-widget-expand-to-full-height-in-w2ui
        ]
    });

    var bp = []

  $().w2toolbar({
    name: 'mainToolbar',
    items: [
      { type: 'button', id: 'reset', text: 'Reset' },
      { type: 'button', id: 'saveExport', text: 'Save/Export', onClick() { w2confirm({
        msg: saveToCode(),
        title: 'Confirmation',
        width: 450,        // width of the dialog
        height: 220,       // height of the dialog
        btn_yes: {
            text  : 'Copy', // text for yes button (or yes_text)
            class : '',    // class for yes button (or yes_class)
            style : '',    // style for yes button (or yes_style)
            click : console.log(JSON.stringify(state))   // callBack for yes button (or yes_callBack)
            // Maybe see if we can copy it to the clickboard automatically with this
        },
        btn_no: {
            text  : 'Close',  // text for no button (or no_text)
            class : '',    // class for no button (or no_class)
            style : '',    // style for no button (or no_style)
            click : null   // callBack for no button (or no_callBack)
        },
        callBack: null,    // common callBack
        onOpen: null,      // event when popup is opened
        onClose: null      // event when popup is closed
      })}},

      { type: 'button', id: 'load', text: 'Load', onClick() { w2prompt({
          label: 'Enter',
          value: '2',
          attrs: 'style="width: 200px"',
          title: w2utils.lang('Notification'),
          ok_text: w2utils.lang('Ok'),
          ok_class: 'ok-class',
          cancel_text: w2utils.lang('Cancel'),
          cancel_class: 'cancel-class',
          width: 400,
          height: 200
      })
      .change((event) => {
          console.log('change', event);
      })
      .ok((event) => {
          console.log(event)
          loadFromCode(event);
      });}}
    ]
  })

  function saveExport() {
      
    }

  $().w2layout({
    name: 'leftPane',
    panels: [
      { type: 'top', size: 50, style: pstyle},
      { type: 'main', size: 500, style: pstyle, resizable: true },
      { type: 'bottom', size: 200, style: pstyle }
    ]
  });

  $().w2toolbar({
    name: 'navigationToolbar',
    items: [
      { type: 'menu-radio', id: 'navigationSortBy',
          text(item) {
            let text = item.selected;
            let el = this.get('navigationSortBy:' + item.selected);
            return 'Sort by: ' + el.text;
          },
          selected: 'sortby-name',
          items: [
            { id: 'sortby-name', text: 'Name' },
            { id: 'sortby-type', text: 'Type' },
            { id: 'sortby-id', text: 'ID'}
          ]
      },
      { type: 'menu-check', id: 'navigationFilter', text: 'Filter',
        selected: ['lot', 'kw'],
        onRefresh(event){
          console.log(event)
          event.item.count = event.item.selected.reduce((a,b) => a + event.item.items.find(i => i.id == b).count, 0);
        },
        items: [
          { id: 'kw', text: 'KW', count: 100 },
          { id: 'lot', text: 'Lots', count: 400}
        ]
      }
    ]
  })

	$().w2sidebar({
		name: 'navigation',
		img: null,
		handle: {
			size: 18,
			//style: 'height: 22px; width: 20px; margin-top: 0px; margin-left: -15px;',
			content: `<div onclick="w2ui.navigation.toggle(this, event)"
                ${w2utils.tooltip('Toggle visability', { className: 'w2ui-light', left: -6, position: 'top|bottom' })}></div>`
		},
		nodes: [],
		toggle(el) {
            // shoulda probably have done this D3 style?
			let node = $(el).closest('.w2ui-node');
			//let nodeID = $(el).closest('.w2ui-node').attr('id')
      let id = node[0].id.substring(5) //dangerous should use regex
  
      if (bp.indexOf(id) != -1) { // Is visible
          bp.splice(bp.indexOf(id), 1)
          $(el).removeClass('toggle')
          hideObject(id, true)

      } else {    // Is hidden
          bp.push(id)
          $(el).addClass('toggle')
          hideObject(id, false)
          
      }
      event.preventDefault()
      event.stopPropagation()
		}
	});
    
	$().w2sidebar({
		name: 'filter',
		img: null,
		nodes: [
			{ id: 'show', text: 'Show',
          nodes: [
              { id: 'showRocks', text: 'Rocks' },
              { id: 'showLines', text: 'Lines' }
          ]
      }
		]
	})

  
  w2ui['layout'].html('top', w2ui['mainToolbar']);
	
  w2ui['layout'].html('left', w2ui['leftPane']);
  w2ui['leftPane'].html('top', w2ui['navigationToolbar']);
  w2ui['leftPane'].html('main', w2ui['navigation']);
	w2ui['leftPane'].html('bottom', w2ui['filter']);
  
  readDataFile()
});

</script>
<script type='text/javascript'>
  var state;

  function loadState(loaded) {
    if (loaded == null) {
      var objectStates = data.map(o => ({id: o._name, 
                                    hidden: true,
                                    fragments: o.location.map((f, index) => ({id: getFragmentName(f.x, f.y, index), hidden: false}))
                                  }));

      state = {filters: {rocks: true, lines: true}, objectStates: objectStates};
      loadState(state);
    } else {
      loaded.objectStates.forEach(o => {hideObject(o.id, o.hidden)});
    } 
  }

  function hideObject(id, hide) {
    state.objectStates.find(o => o.id == id).hidden = hide;

    let object = data.find(o => o._name == id);
    let locationsToUpdate = objectsByDots.filter(e => object.location.some(l => compareLocation(e.location, l)));

    if (hide) {
      locationsToUpdate.forEach(e => e.objects = e.objects.filter(o => o._name != object._name))
      locationsToUpdate.forEach(svgloc => {
          if (svgloc.objects.length == 0) {
              svgloc.svgNode.setAttribute("visiblity", "hidden")
              svgloc.textNode.setAttribute("visibility", "hidden")
          } else {
              if (svgloc.objects.length == 1) {
                  svgloc.textNode.innerHTML = svgloc.objects[0]._name
              } else {
                  svgloc.textNode.innerHTML = svgloc.objects[0]._name + " +" + (svgloc.objects.length - 1)
              }
          }
      });
    } else {
      locationsToUpdate.forEach(e => { e.objects.push(object)})
      locationsToUpdate.forEach(svgloc => {
          svgloc.svgNode.setAttribute("visibility", "visible")
          svgloc.textNode.setAttribute("visibility", "visible")
          if (svgloc.objects.length == 1) {
              svgloc.textNode.innerHTML = svgloc.objects[0]._name
          } else {
              svgloc.textNode.innerHTML = svgloc.objects[0]._name + " +" + (svgloc.objects.length - 1)
          }
      });
    }
  }
  

  function hideFragment(id) {

  }

  function saveToCode() {
    console.log("saving")
    return JSON.stringify(state) 
  }

  function selectObject(object) { //add to save load
    state.selectedObject = object
    w2ui['layout'].panels.find(p => p.type == 'right').loadObject()
  }

  function loadFromCode(code) {
    try {
      // Probably need to regex
      state = JSON.parse(code)
      loadState(state)
    } catch (e) {
      if (e instanceof SyntaxError) {
        w2alert('Invalid code')
      } else {
        w2alert('Something bad happened, please email kaltagkaasen@gmail.com with what you did, becuase frankly I did not expect anything to happen. :)')
      }
    }
  }

</script>

</body>
</html>
